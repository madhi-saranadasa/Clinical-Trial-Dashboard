---
title: "AppDevelopment"
author: "Madhi Saranadasa"
date: '2022-06-14'
output: html_document
---

```{r}

library(tidyverse)
library(ggmap)
library(leaflet)
library(lubridate)
library(htmltools)
library(RColorBrewer)
library(leaflet)
register_google(key = 'AIzaSyCBWs3C3m6xv36WH3ZLYyMigr7jecT5p00')

projectfolder <- dirname(getwd())
datafolder <- file.path(projectfolder, "Data")

```

# Load data

```{r}

filenames <- list.files(datafolder)
filenames <- filenames[str_detect(filenames, "CTD")]
filenames <- str_remove(filenames, ".csv")

filepaths <- list.files(datafolder, full.names = TRUE)
filepaths <- filepaths[str_detect(filepaths, "CTD")]

for (i in 1:length(filepaths)) {
  temp <- read_csv(filepaths[i])
  assign(filenames[i], temp)
}

rm(temp)

```


```{r}

    locations <- CTD_LocationAdded %>%
      filter(id %in% finalStudies) %>%
      inner_join(colormap, by = "id") %>%
      mutate(label = paste0(id))
    
    icons2 <- awesomeIcons(
      icon = 'home',
      iconColor = 'white',
      library = 'glyphicon',
      markerColor = locations$color
    )

    leafletProxy("mymap", data = locations) %>%
      clearShapes() %>%
      clearMarkers() %>%
      addAwesomeMarkers(lng = ~lon,
                        lat = ~lat,
                        icon = icons2,
                        popup = ~htmlEscape(label),
                        layerId = ~markerID,
                        labelOptions = labelOptions(noHide = F, direction = 'auto'),
                        options = markerOptions(riseOnHover = TRUE))


```


```{r}
locations <- CTD_LocationAdded %>%
  filter(id == "NCT02324855") %>%
  mutate(label = paste0(id))

bounds <- locations %>%
  summarise(n = n(),
            meanlat = mean(lat, na.rm = TRUE)) 

icons2 <- awesomeIcons(
      icon = 'home',
      iconColor = 'white',
      library = 'glyphicon',
      markerColor = locations$color
    )


basemap <- leaflet(data = locations) %>%
      addTiles() %>%
      fitBounds(bounds$minlon, bounds$minlat, bounds$maxlon, bounds$maxlat) %>%
      addAwesomeMarkers(lng = ~lon,
                            lat = ~lat,
                            icon = icons2,
                            popup = ~htmlEscape(label),
                            layerId = ~markerID,
                            labelOptions = labelOptions(noHide = F, direction = 'auto'),
                            options = markerOptions(riseOnHover = TRUE))
    
basemap
```